name: Run Azure ML Dataprep and Training Pipelines

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'pipelines/**.yaml'
      - '.github/workflows/run-azure-preprocess-n-train-pipeline.yml'

env:
  GROUP: mlops-project
  WORKSPACE: mlops-project-ai
  LOCATION: westeurope

jobs:
  run-pipelines:
    runs-on: [self-hosted, Linux]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Login to Azure
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Install Azure ML CLI extension
      run: |
        python3 -m venv .venv
        source .venv/bin/activate
        pip install --upgrade pip
        pip install rpds-py
        az extension remove --name ml || true
        az extension add --name ml --allow-preview
        az configure --defaults group=$GROUP workspace=$WORKSPACE location=$LOCATION
        
    - name: Create Azure ML Compute
      run: |
        az ml compute create --file ./environment/compute.yaml
        
    - name: Start Azure ML Compute
      run: |
        az ml compute start --name ai-training-compute
      continue-on-error: true

    - name: Create Environments
      run: |
        az ml environment create --file ./environment/pillow.yaml || true
        az ml environment create --file ./environment/tensorflow.yaml || true
        
    - name: Create Components
      run: |
        az ml component create --file ./components/dataprep/dataprep.yaml --set version=0.2.${{ github.run_number }}
        az ml component create --file ./components/dataprep/split.yaml --set version=0.2.${{ github.run_number }}
        az ml component create --file ./components/training/training.yaml --set version=0.2.${{ github.run_number }}
        
    - name: Run Preprocessing Pipeline
      run: |
        az ml job create \
          --file ./pipelines/preprocessing.yaml \
          --stream \
          --set name=preprocessing-${{ github.sha }}-${{ github.run_id }}
          
    - name: Get actual URI of splitted_data output
      id: get_output_uri
      run: |
        echo "Fetching splitted_data URI for job preprocessing-${{ github.sha }}-${{ github.run_id }}"
        az ml job show --name preprocessing-${{ github.sha }}-${{ github.run_id }} --output json
        uri=$(az ml job show --name preprocessing-${{ github.sha }}-${{ github.run_id }} --query "outputs.splitted_data.uri" -o tsv)
        echo "Resolved OUTPUT_URI: $uri"
        echo "OUTPUT_URI=$uri" >> $GITHUB_ENV

          
    - name: Register splitted_data output as versioned data asset
      run: |
        az ml data create \
          --name splitted_train_data \
          --version ${{ github.run_id }} \
          --type uri_folder \
          --path ${{ env.OUTPUT_URI }} \
          --description "Auto-registered from preprocessing pipeline run" \
          --resource-group $GROUP \
          --workspace-name $WORKSPACE
          
    - name: Run Training Pipeline & Stop Compute
      run: |
        az ml job create \
          --file ./pipelines/training.yaml \
          --stream \
          --set name=training-${{ github.sha }}-${{ github.run_id }}
          
        az ml compute stop --name ai-training-compute
      continue-on-error: true
