name: Run Azure ML Dataprep and Training Pipelines

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'pipelines/**.yaml'
      - '.github/workflows/run-azure-preprocess-n-train-pipeline.yml'

env:
  GROUP: mlops-project
  WORKSPACE: mlops-project-ai
  LOCATION: westeurope

jobs:
  run-pipelines:
    runs-on: [self-hosted, Linux]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Login to Azure
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Install Azure ML CLI extension
      run: |
        az extension remove --name ml || true
        az extension add --name ml --allow-preview
        pip install --upgrade rpds-py  # Fix for common ML extension issue
        az configure --defaults group=$GROUP workspace=$WORKSPACE location=$LOCATION

    - name: Create Azure ML Compute
      run: |
        az ml compute create --file ./environment/compute.yaml

    - name: Start Azure ML Compute
      run: |
        az ml compute start --name ai-training-compute
      continue-on-error: true

    - name: Create Environments
      run: |
        az ml environment create --file ./environment/pillow.yaml
        az ml environment create --file ./environment/tensorflow.yaml

    - name: Create Components
      run: |
        az ml component create --file ./components/dataprep/dataprep.yaml
        az ml component create --file ./components/dataprep/split.yaml
        az ml component create --file ./components/training/training.yaml

    - name: Run Preprocessing Pipeline
      run: |
        az ml job create \
          --file ./pipelines/preprocessing.yaml \
          --stream \
          --set name=preprocessing-${{ github.sha }}-${{ github.run_id }}

    - name: Run Training Pipeline & Stop Compute
      run: |
        az ml job create \
          --file ./pipelines/training.yaml \
          --stream \
          --set name=training-${{ github.sha }}-${{ github.run_id }}
        az ml compute stop --name ai-training-compute
      continue-on-error: true
